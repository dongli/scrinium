<!-- 如果没有传入current_folder，则必须传入folderable。 -->
<% if not defined? current_folder or not current_folder %>
  <!-- 很抱歉在这里添加增加root文件夹的逻辑，因为在model中无法访问到current_user。 -->
  <% if folderable.folders.empty? %>
    <% folderable.folders.create(
      name: 'root',
      user_id: current_user.id,
      folderable_id: folderable.id,
      folderable_type: folderable.class.to_s
    ) %>
  <% end %>

  <!-- 默认第一个文件夹为当前文件夹。 -->
  <% current_folder = folderable.folders.first %>
<% end %>
<!-- 从cookie中查看是否记录有当前文件夹ID。 -->
<% current_folder_id = cookies[:current_folder_id] %>
<% if current_folder_id and current_folder_id != current_folder.id %>
  <!-- 如果有，则更改当前文件夹。 -->
  <% tmp = Folder.find_by id: current_folder_id %>
  <!-- 为了避免泄露文件，我们必须判断folderable的一致性。 -->
  <% current_folder = tmp if tmp and tmp.folderable == current_folder.folderable %>
<% else %>
  <% cookies[:current_folder_id] = { value: "#{current_folder.id}", path: request.fullpath } %>
<% end %>
<div id='resource-board' data-current-folder='<%= current_folder.id %>'
  data-folderable-type='<%= current_folder.folderable_type %>'
  data-folderable-id='<%= current_folder.folderable_id %>'>
  <ol class='breadcrumb'>
    <% folder = current_folder %>
    <% parent_folders = [] %>
    <% while folder.parent_id do %>
      <% parent_folders << folder.parent %>
      <% folder = folder.parent %>
    <% end %>
    <% parent_folders.reverse.each do |parent_folder| %>
      <% if parent_folder.parent_id %>
        <li><%= link_to parent_folder.name, parent_folder, remote: true %></li>
      <% else %>
        <li><%= link_to fa_icon('home'), parent_folder, remote: true %></li>
      <% end %>
    <% end %>
    <% if current_folder.parent %>
      <li class='active'><%= link_to current_folder.name, current_folder, remote: true %></li>
    <% else %>
      <li class='active'><%= link_to fa_icon('home'), current_folder, remote: true %></li>
    <% end %>
  </ol>

  <div class='resource-board-actions'>
    <ul class='inline'>
      <li>
        <%=
          link_to fa_icon('plus-square-o', text: '文件'),
          [ :new, :resource, folder_id: current_folder.id,
            resourceable_type: current_folder.folderable_type,
            resourceable_id: current_folder.folderable_id ],
          remote: true
        %>
      </li>
      <li>
        <%=
          link_to fa_icon('plus-square-o', text: '文件夹'),
          [ :new, :folder, parent_id: current_folder.id,
            folderable_type: current_folder.folderable_type,
            folderable_id: current_folder.folderable_id ],
          remote: true
        %>
      </li>
    </ul>
  </div>

  <table class='table'>
    <thead id='resource-board-table-head'>
      <tr>
        <th width='100'>名称</th>
        <th width='100'>创建时间</th>

        <th colspan=2 id='resource-board-file-actions' style='display: none;'>
          <ul class='resource-board-file-actions'>
            <li class='for-single-file'>
              <%=
                link_to fa_icon('edit', text: '重命名'), rename_file_path(
                  folderable_type: current_folder.folderable.class,
                  folderable_id: current_folder.folderable.id
                ), remote: true, id: 'rename-file'
              %>
            </li>
            <li>
              <%=
                link_to fa_icon('trash', text: '删除'), delete_files_path(
                folderable_type: current_folder.folderable.class,
                folderable_id: current_folder.folderable.id
                ), remote: true, id: 'delete-files'
              %>
            </li>
            <li>
              <%=
                link_to fa_icon('wheelchair', text: '移动'), move_files_path(
                  folderable_type: current_folder.folderable.class,
                  folderable_id: current_folder.folderable.id
                ), remote: true, id: 'move-files'
              %>
            </li>
            <li>
              <%=
                link_to fa_icon('share-alt', text: '分享'), share_files_path(
                  folderable_type: current_folder.folderable.class,
                  folderable_id: current_folder.folderable.id
                ), remote: true, id: 'share-files'
              %>
            </li>
          </ul>
        </th>
      </tr>
    </thead>
    <tbody id='resource-board-table'>
      <% current_folder.children.sort_by { |x| x.name }.each do |child| %>
        <%= render 'resource_board/folder_table_row', folder: child %>
      <% end %>
      <% current_folder.resources.sort_by { |x| x.name }.each do |resource| %>
        <%= render 'resource_board/resource_table_row', resource: resource %>
      <% end %>
    </tbody>
  </table>

  <!-- 添加文件夹的modal -->
  <div class='modal fade' id='add-folder' tabindex='-1' role='dialog' aria-labelledby='add-folder-label'>
    <div class='modal-dialog modal-sm' role='document'>
      <div class='modal-content'>
        <div class='modal-header center'>
          <h4 class='modal-title'>创建文件夹</h4>
        </div>
        <div class='modal-body'>
          <%= render 'folders/form', folder: Folder.new %>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加文件的modal -->
  <div class='modal fade' id='add-resource' tabindex='-1' role='dialog' aria-labelledby='add-resource-label'>
    <div class='modal-dialog modal-bg' role='document'>
      <div class='modal-content'>
        <div class='modal-header center'>
          <h4 class='modal-title'>创建文件</h4>
        </div>
        <div class='modal-body'>
          <%= render 'resources/form', resource: Resource.new %>
        </div>
      </div>
    </div>
  </div>

  <!-- 删除文件或文件夹的modal -->
  <div class='modal fade' id='delete-files' tabindex='-1' role='dialog' aria-labelledby='delete-files-label'>
    <div class='modal-dialog modal-sm' role='document'>
      <div class='modal-content'>
        <div class='modal-header center'>
          <h4 class='modal-title'>是否执行删除？</h4>
        </div>
        <div class='modal-body'>
          <div id='delete-files-message'></div>
          <div class='center'>
            <button id='delete-files' class='btn btn-danger'>删除</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 移动文件或文件夹的modal -->
  <div class='modal fade' id='move-files' tabindex='-1' role='dialog' aria-labelledby='move-files-label'>
    <div class='modal-dialog modal-sm' role='document'>
      <div class='modal-content'>
        <div class='modal-header center'>
          <h4 class='modal-title'>移动到 ...</h4>
        </div>
        <div class='modal-body'>
          <div id='move-files-container'></div>
          <div class='center'>
            <button id='move-files' class='btn btn-primary'>移动</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
