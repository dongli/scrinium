#!/usr/bin/env ruby
require 'pathname'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

Dir.chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  puts "== Installing dependencies =="
  system "gem install bundler --conservative"
  system "bundle check || bundle install"

  puts "\n== Configure nginx =="
  File.open('./config/nginx.conf', 'w').write <<-EOT
  upstream app {
      server unix:#{APP_ROOT}/tmp/sockets/unicorn.sock fail_timeout=0;
  }

  server {
      listen 3000;
      server_name localhost;

      root #{APP_ROOT}/public;

      try_files $uri/index.html $uri @app;

      location @app {
          proxy_pass http://app;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Host $http_host;
          proxy_redirect off;
      }

      error_page 500 502 503 504 /500.html;
      client_max_body_size 4G;
      keepalive_timeout 10;
  }
  EOT

  puts "\n== Preparing database =="
  system 'bin/rake acts_as_taggable_on_engine:install:migrations'
  system 'bin/rake mailboxer_engine:install:migrations'
  system "bin/rake db:setup"

  puts "\n== Removing old logs and tempfiles =="
  system "rm -f log/*"
  system "rm -rf tmp/cache"

  puts "\n== Restarting application server =="
  system "touch tmp/restart.txt"
end
